name: æ›´æ–° README ç»Ÿè®¡æ•°æ®

on:
  workflow_dispatch:
  schedule:
    # æ¯å­£åº¦é¦–æ—¥ 08:00 åŒ—äº¬æ—¶é—´ (3/1, 6/1, 9/1, 12/1)
    - cron: '0 0 1 3,6,9,12 *'

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # æ£€å‡ºä»£ç ä»“åº“
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ›´å¥½çš„ git log åˆ†æ

      # è®¾ç½® Python å’Œ jq
      - name: è®¾ç½® Python å’Œ jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          echo "âœ… ä¾èµ–å·²å®‰è£…"

      # éªŒè¯è„šæœ¬æ˜¯å¦å­˜åœ¨
      - name: éªŒè¯è„šæœ¬æ˜¯å¦å­˜åœ¨
        run: |
          if [ ! -f "scripts/generate-stats.py" ]; then
            echo "âŒ é”™è¯¯: scripts/generate-stats.py æœªæ‰¾åˆ°"
            exit 1
          fi
          echo "âœ… è„šæœ¬å·²æ‰¾åˆ°"

      # ç¡®å®šç›®æ ‡ç”¨æˆ·å’Œæäº¤ä½œè€…
      - name: ç¡®å®šç›®æ ‡ç”¨æˆ·å’Œæäº¤ä½œè€…
        id: determine-users
        run: |
          echo "ğŸ” æ­£åœ¨ç¡®å®šç»Ÿè®¡ç›®æ ‡å’Œæäº¤ä½œè€…..."

          # é€šè¿‡æŸ¥è¯¢ GitHub API æ£€æŸ¥æ˜¯å¦ä¸º Fork ä»“åº“
          REPO_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}")

          IS_FORK=$(echo "$REPO_INFO" | jq -r '.fork // false')

          if [ "$IS_FORK" = "true" ]; then
            # è¿™æ˜¯ Fork ä»“åº“
            ORIGIN_USERNAME="${{ github.repository_owner }}"
            UPSTREAM_USERNAME=$(echo "$REPO_INFO" | jq -r '.parent.owner.login // .source.owner.login // empty')

            if [ -n "$UPSTREAM_USERNAME" ] && [ "$UPSTREAM_USERNAME" != "null" ]; then
              echo "ğŸ´ æ£€æµ‹åˆ° Fork ä»“åº“"
              echo "ğŸ‘¤ è¿œç«¯ç”¨æˆ·å: $ORIGIN_USERNAME"
              echo "ğŸ‘‘ ä¸Šæ¸¸ç”¨æˆ·å: $UPSTREAM_USERNAME"
            else
              UPSTREAM_USERNAME="$ORIGIN_USERNAME"
              echo "ğŸ´ Fork ä»“åº“ä½†æ— æ³•è·å–ä¸Šæ¸¸ä¿¡æ¯"
              echo "ğŸ‘¤ è¿œç«¯ç”¨æˆ·å: $ORIGIN_USERNAME"
              echo "ğŸ‘‘ ä¸Šæ¸¸ç”¨æˆ·å: $UPSTREAM_USERNAME"
            fi
          else
            # è¿™æ˜¯åŸå§‹ä»“åº“
            ORIGIN_USERNAME="${{ github.repository_owner }}"
            UPSTREAM_USERNAME="${{ github.repository_owner }}"
            echo "ğŸ“¦ æ£€æµ‹åˆ°åŸå§‹ä»“åº“"
            echo "ğŸ‘¤ è¿œç«¯ç”¨æˆ·å: $ORIGIN_USERNAME"
            echo "ğŸ‘‘ ä¸Šæ¸¸ç”¨æˆ·å: $UPSTREAM_USERNAME"
          fi

          echo "ORIGIN_USERNAME=$ORIGIN_USERNAME" >> $GITHUB_OUTPUT
          echo "UPSTREAM_USERNAME=$UPSTREAM_USERNAME" >> $GITHUB_OUTPUT
          echo "âœ… ç”¨æˆ·å·²ç¡®å®š"

          # æ ¹æ®è§¦å‘ç±»å‹ç¡®å®šæäº¤ä½œè€…
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼Œå¸¦ä¸Šè§¦å‘è€…
            echo "ğŸ‘† æ£€æµ‹åˆ°æ‰‹åŠ¨è§¦å‘"
            TRIGGER_USER="${{ github.triggering_actor }}"

            USER_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/users/$TRIGGER_USER")
            USER_ID=$(echo "$USER_INFO" | jq -r '.id // null')

            if [ -n "$USER_ID" ] && [ "$USER_ID" != "null" ]; then
              PRIVACY_EMAIL="$USER_ID+$TRIGGER_USER@users.noreply.github.com"
            else
              PRIVACY_EMAIL="$TRIGGER_USER@users.noreply.github.com"
            fi

            echo "co_authors=Co-authored-by: $TRIGGER_USER <$PRIVACY_EMAIL>" >> $GITHUB_OUTPUT
            echo "ğŸ‘¤ ä½œè€…: GitHub Actions + $TRIGGER_USER"
          else
            # å®šæ—¶ä»»åŠ¡æˆ– Pushï¼Œåªæœ‰ GitHub Actions
            echo "co_authors=" >> $GITHUB_OUTPUT
            echo "ğŸ¤– ä½œè€…: GitHub Actions"
          fi

          echo "trigger_type=${{ github.event_name }}" >> $GITHUB_OUTPUT

      # ç”Ÿæˆç»Ÿè®¡æ•°æ®
      - name: ç”Ÿæˆç»Ÿè®¡æ•°æ®
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORIGIN_USERNAME: ${{ steps.determine-users.outputs.ORIGIN_USERNAME }}
          UPSTREAM_USERNAME: ${{ steps.determine-users.outputs.UPSTREAM_USERNAME }}
        run: |
          echo "ğŸš€ å¼€å§‹ç”Ÿæˆç»Ÿè®¡æ•°æ®..."
          echo "ğŸ‘¤ ç›®æ ‡ç”¨æˆ·: $ORIGIN_USERNAME"
          echo "ğŸ“Š ä»“åº“: ${{ github.repository }}"

          # éªŒè¯ç¯å¢ƒå˜é‡
          if [ -z "$GH_TOKEN" ]; then
            echo "âŒ é”™è¯¯: GH_TOKEN æœªè®¾ç½®"
            exit 1
          fi

          if [ -z "$ORIGIN_USERNAME" ]; then
            echo "âŒ é”™è¯¯: ORIGIN_USERNAME æœªè®¾ç½®"
            exit 1
          fi

          # è¿è¡Œè„šæœ¬ï¼Œå¸¦è¶…æ—¶å’Œé”™è¯¯å¤„ç†
          timeout 25m python3 scripts/generate-stats.py || {
            echo "âŒ ç»Ÿè®¡ç”Ÿæˆå¤±è´¥æˆ–è¶…æ—¶"
            echo "ğŸ“‹ æ£€æŸ¥éƒ¨åˆ†ç»“æœ..."
            if [ -f "README.md" ]; then
              echo "âœ… README.md å­˜åœ¨ï¼Œæ£€æŸ¥æ›´æ”¹..."
              git diff --name-only
            fi
            exit 1
          }

          echo "âœ… ç»Ÿè®¡æ•°æ®ç”ŸæˆæˆåŠŸ"

      # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check-changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  æœªæ£€æµ‹åˆ°æ›´æ”¹"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹:"
            git diff --name-only
          fi

      # æäº¤å¹¶æ¨é€
      - name: æäº¤å¹¶æ¨é€
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          echo "ğŸ“¤ æ­£åœ¨æäº¤å’Œæ¨é€æ›´æ”¹..."

          # é…ç½® git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ æ›´æ”¹
          git add README.md scripts/stats_cache/

          # åˆ›å»ºæäº¤
          if [ -n "${{ steps.determine-users.outputs.co_authors }}" ]; then
            git commit \
              -m "ğŸ“Š æ›´æ–°ç»Ÿè®¡ï¼ˆè‡ªåŠ¨ï¼‰" \
              -m "${{ steps.determine-users.outputs.co_authors }}"
          else
            git commit -m "ğŸ“Š æ›´æ–°ç»Ÿè®¡ï¼ˆè‡ªåŠ¨ï¼‰"
          fi

          # æ¨é€æ›´æ”¹
          if git push; then
            echo "âœ… æ›´æ”¹æ¨é€æˆåŠŸ"
          else
            echo "âŒ æ¨é€æ›´æ”¹å¤±è´¥"
            exit 1
          fi

      # æ‘˜è¦
      - name: æ‘˜è¦
        if: always()
        run: |
          echo "ğŸ“‹ å·¥ä½œæµæ‘˜è¦:"
          echo "- ä»“åº“: ${{ github.repository }}"
          echo "- è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "- è¿œç«¯ç”¨æˆ·å: ${{ steps.determine-users.outputs.ORIGIN_USERNAME }}"
          echo "- ä¸Šæ¸¸ç”¨æˆ·å: ${{ steps.determine-users.outputs.UPSTREAM_USERNAME }}"
          echo "- æ˜¯å¦æœ‰æ›´æ”¹: ${{ steps.check-changes.outputs.changes || 'unknown' }}"
